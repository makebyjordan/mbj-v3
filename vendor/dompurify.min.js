(function (root) {
  'use strict';

  function sanitize(input) {
    var html = String(input == null ? '' : input);
    var parser = new DOMParser();
    var doc = parser.parseFromString('<div>' + html + '</div>', 'text/html');
    var allowedTags = new Set([
      'DIV','P','BR','STRONG','EM','B','I','U','UL','OL','LI','A','H1','H2','H3','H4','H5','H6','BLOCKQUOTE','CODE','PRE','HR','SPAN','IMG','TABLE','THEAD','TBODY','TR','TH','TD'
    ]);
    var allowedAttrs = new Set(['href','src','alt','title','target','rel']);

    var nodes = doc.body.querySelectorAll('*');
    nodes.forEach(function (node) {
      if (!allowedTags.has(node.tagName)) {
        var text = doc.createTextNode(node.textContent || '');
        node.replaceWith(text);
        return;
      }

      Array.from(node.attributes).forEach(function (attr) {
        var name = attr.name.toLowerCase();
        var value = attr.value || '';
        var isEvent = name.indexOf('on') === 0;
        var isStyle = name === 'style';
        var allowed = allowedAttrs.has(name);

        if (isEvent || isStyle || !allowed) {
          node.removeAttribute(attr.name);
          return;
        }

        if ((name === 'href' || name === 'src') && /^javascript:/i.test(value.trim())) {
          node.removeAttribute(attr.name);
          return;
        }

        if (name === 'target') {
          node.setAttribute('rel', 'noopener noreferrer');
        }
      });
    });

    return doc.body.innerHTML;
  }

  root.DOMPurify = {
    sanitize: sanitize
  };
})(window);
